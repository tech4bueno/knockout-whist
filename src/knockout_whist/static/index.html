<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knockout Whist</title>
    <script src="tailwind.js"></script>
<style>

    @keyframes errorAnnouncement {
        0% { opacity: 0; transform: translateY(-20px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    @keyframes cardPlay {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    @keyframes trickComplete {
        0% { background-color: transparent; }
        100% { background-color: rgba(59, 130, 246, 0.1); }
    }

    @keyframes winnerAnnouncement {
        0% { opacity: 0; transform: translateY(-20px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    .error-announcement {
        animation: errorAnnouncement 0.5s ease-out;
    }

    .card-played {
        animation: cardPlay 0.3s ease-out;
    }

    .trick-complete {
        animation: trickComplete 0.5s ease-out forwards;
    }

    .winner-announcement {
        animation: winnerAnnouncement 0.5s ease-out;
    }

    @media (max-width: 640px) {
        .card-size {
            width: 3rem;
            height: 4.5rem;
            font-size: 1.5rem;
        }
        
        .card-container {
            gap: 0.5rem;
        }
    }
</style>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- Login Screen -->
    <div id="loginScreen" class="flex min-h-screen items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-sm bg-white rounded-lg shadow-lg p-4 sm:p-6">
            <div class="mb-4">
                <h2 class="text-xl font-bold">Knockout Whist</h2>
            </div>
            <div class="space-y-4">
                <input
                    type="text"
                    id="playerNameInput"
                    placeholder="Your Name"
                    class="w-full px-3 py-2 border rounded-md"
                >
                <input
                    type="text"
                    id="gameCodeInput"
                    placeholder="Game Code (to join)"
                    class="w-full px-3 py-2 border rounded-md"
                >
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <button 
                        onclick="createGame()"
                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 w-full sm:w-auto"
                    >
                        Create Game
                    </button>
                    <button 
                        onclick="joinGame()"
                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 w-full sm:w-auto"
                    >
                        Join Game
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="min-h-screen bg-gray-100 p-2 sm:p-4 hidden">
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-3 sm:p-6 border-b">
                <h2 class="text-lg sm:text-xl font-bold">
                    Game: <span id="gameCodeDisplay"></span> - 
                    Round <span id="currentRound"></span>
                </h2>
            </div>
            <div class="p-3 sm:p-6 space-y-4">
                <!-- Game Status -->
                <div>
                    <h3 class="text-base sm:text-lg font-semibold">
                        Trumps: <span id="trumpSuit"></span>
                    </h3>
                    <p id="trumpChooserMessage" class="text-sm text-gray-600 hidden"></p>
                </div>

                <!-- Players -->
                <div id="playersGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-4"></div>

                <!-- Current Hand -->
                <div id="currentTrickContainer" class="border p-2 sm:p-4 rounded hidden">
                    <h3 class="font-semibold mb-2">Current Hand:</h3>
                    <div id="currentTrick" class="flex flex-wrap justify-center card-container"></div>
                </div>

                <!-- Player's Hand -->
                <div id="playerHand" class="hidden">
                    <h3 class="font-semibold mb-2">Your Hand:</h3>
                    <div id="handCards" class="flex flex-wrap gap-2 sm:gap-4 justify-center card-container"></div>
                </div>

                <div class="flex space-x-2">
                    <button 
                        id="startGameButton" 
                        onclick="startGame()"
                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 w-full sm:w-auto hidden"
                    >
                        Start Game
                    </button>
                    <button 
                        id="addAIButton" 
                        onclick="addAIPlayer()"
                        class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 w-full sm:w-auto hidden"
                    >
                        Add AI Player
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Trump Selection Dialog -->
    <div id="trumpDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full">
            <h2 class="text-lg sm:text-xl font-bold mb-4">Choose Trump Suit</h2>
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="chooseTrump('♠')" class="card-size flex items-center justify-center hover:scale-110 transition-transform bg-white border rounded">♠</button>
                <button onclick="chooseTrump('♥')" class="card-size flex items-center justify-center hover:scale-110 transition-transform bg-white border rounded text-red-500">♥</button>
                <button onclick="chooseTrump('♦')" class="card-size flex items-center justify-center hover:scale-110 transition-transform bg-white border rounded text-red-500">♦</button>
                <button onclick="chooseTrump('♣')" class="card-size flex items-center justify-center hover:scale-110 transition-transform bg-white border rounded">♣</button>
            </div>
        </div>
    </div>

    <script>
        let sessionId = localStorage.getItem('sessionId');
        let ws = null;
        let gameState = null;
        let playerName = '';
        let hand = [];

        function getCardColor(card) {
            const suit = card.slice(-1);
            return ['♥', '♦'].includes(suit) ? 'text-red-500' : 'text-black';
        }

        function isCardPlayable(card) {
            if (!gameState?.currentTrick || gameState.currentTrick.length === 0) return true;
            
            const suit = card.slice(-1);
            const [, firstCard] = gameState.currentTrick[0];
            const leadSuit = firstCard.slice(-1);
            
            const hasLeadSuit = hand.some(c => c.slice(-1) === leadSuit);
            if (hasLeadSuit) {
                return (suit === leadSuit);
            }
            return true;
        }

        function showError(message) {
            // Remove any existing error messages
            const existingErrors = document.querySelectorAll('.error-announcement');
            existingErrors.forEach(error => error.remove());
            
            // Show the error message
            const announcement = document.createElement('div');
            announcement.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg error-announcement';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                announcement.style.opacity = '0';
                announcement.style.transition = 'opacity 0.5s ease-out';
                setTimeout(() => announcement.remove(), 500);
            }, 3000);
        }

        function addAIPlayer() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'addAI'
                }));
            } else {
                showError('Connection lost. Please refresh to reconnect.');
            }
        }

        function connectWebSocket(message) {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsHost = window.location.host;
            ws = new WebSocket(`${wsProtocol}//${wsHost}/ws`);

            ws.onopen = () => {
                if (sessionId) {
                    playerName = localStorage.getItem('playerName');
                    ws.send(JSON.stringify({
                        type: 'reconnect',
                        sessionId: sessionId
                    }));
                } else {
                    playerName = message.name;
                    localStorage.setItem('playerName', playerName);
                    ws.send(JSON.stringify(message));
                }
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'error' && data.message === 'Invalid session') {
                    localStorage.removeItem('sessionId');
                    localStorage.removeItem('playerName');
                    sessionId = null;
                    playerName = null;
                    showLoginScreen();
                    return;
                }
                
                // Save session ID when received
                if (data.sessionId) {
                    sessionId = data.sessionId;
                    localStorage.setItem('sessionId', sessionId);
                }
                handleWebSocketMessage(data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                showError('Connection error. Please try again.');
            };

            ws.onclose = () => {
                console.log('WebSocket connection closed');
                showError('Connection closed. Please refresh to reconnect.');
            };
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'gameCreated':
                case 'gameState':
                case 'playerJoined':
                case 'joined':
                    gameState = data.state;
                    hand = data.state?.hand || [];
                    showGameScreen();
                    updateGameState(data.state);
                    break;
                
                case 'cardPlayed':
                    if (data.player === playerName) {
                        hand = hand.filter(card => card !== data.card);
                    }
                    gameState = data.state;
                    gameState.currentPlayer = data.nextPlayer;
                    gameState.lastPlayedCard = data.card;
                    gameState.lastPlayer = data.player;
                    updateGameState(data.state);
                    break;

                case 'trickComplete':
                    gameState = data.state;
                    delete gameState.lastPlayedCard;
                    delete gameState.lastPlayer;
                    updateGameState(data.state);
                    showTrickComplete();
                    break;

                case 'trickWinner':
                    gameState = data.state;
                    gameState.currentPlayer = data.nextPlayer;
                    showTrickWinner(data.winner);
                    break;

                case 'nextTrick':
                    gameState = data.state;
                    clearTrickWithAnimation(() => {
                        updateGameState(data.state);
                    });
                    break;
                
                case 'roundEnd':
                    gameState = data.state;
                    updateGameState(data.state);
                    if (data.trumpCaller === playerName) {
                        showTrumpDialog();
                    }
                    break;
                
                case 'roundStart':
                    gameState = data.state;
                    hand = data.state.hand || [];
                    hideTrumpDialog();
                    updateGameState(data.state);
                    break;
                
                case 'error':
                    showError(data.message);
                    break;
                
                case 'eliminated':
                    showError('You have been eliminated!');
                    break;
                
                case 'playerLeft':
                    gameState = data.state;
                    updateGameState(data.state);
                    break;
                
                case 'gameOver':
                    gameState = data.state;
                    updateGameState(data.state);
                    showError(`Game Over! Winner: ${data.winner}`);
                    break;
            }
        }

        function createGame() {
            playerName = document.getElementById('playerNameInput').value;
            if (!playerName) {
                showError('Please enter your name');
                return;
            }
            connectWebSocket({
                type: 'create',
                name: playerName
            });
        }

        function joinGame() {
            playerName = document.getElementById('playerNameInput').value;
            const gameCode = document.getElementById('gameCodeInput').value;
            if (!playerName || !gameCode) {
                showError('Please enter your name and game code');
                return;
            }
            connectWebSocket({
                type: 'join',
                name: playerName,
                code: gameCode.toUpperCase()
            });
        }

        function startGame() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'startGame' }));
            } else {
                showError('Connection lost. Please refresh to reconnect.');
            }
        }

        function animateCardPlay(card, playerName) {
            const cardDiv = document.createElement('div');
            cardDiv.className = `card-size flex items-center justify-center card-played ${getCardColor(card)} border rounded`;
            cardDiv.innerHTML = card;
            
            const playerDiv = document.createElement('div');
            playerDiv.className = 'mt-2 text-center text-sm';
            playerDiv.textContent = playerName;
            
            const container = document.createElement('div');
            container.className = 'text-center m-1';
            container.appendChild(cardDiv);
            container.appendChild(playerDiv);
            
            document.getElementById('currentTrick').appendChild(container);
        }

        function showTrickComplete() {
            const trickContainer = document.getElementById('currentTrickContainer');
            trickContainer.classList.add('trick-complete');
        }

        function showTrickWinner(winner) {
            const announcement = document.createElement('div');
            announcement.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg winner-announcement';
            announcement.textContent = `${winner} wins the trick!`;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                announcement.style.opacity = '0';
                announcement.style.transition = 'opacity 0.5s ease-out';
                setTimeout(() => announcement.remove(), 500);
            }, 1500);
        }

        function clearTrickWithAnimation(callback) {
            const trickContainer = document.getElementById('currentTrickContainer');
            trickContainer.style.opacity = '0';
            trickContainer.style.transition = 'opacity 0.5s ease-out';
            
            setTimeout(() => {
                trickContainer.innerHTML = '<div id="currentTrick" class="flex justify-center space-x-4"></div>';
                trickContainer.style.opacity = '1';
                trickContainer.classList.remove('trick-complete');
                if (callback) callback();
            }, 500);
        }

        function playCard(card) {

            if (ws && ws.readyState === WebSocket.OPEN && 
                gameState?.currentPlayer === playerName && 
                isCardPlayable(card)) {
                
                const cardElement = event.currentTarget;
                cardElement.classList.add('card-played');
                
                setTimeout(() => {
                    ws.send(JSON.stringify({
                        type: 'playCard',
                        card
                    }));
                }, 300); // Wait for animation to complete
            }
        }

        function chooseTrump(suit) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'callTrumps',
                    suit
                }));
                hideTrumpDialog();
            }
        }

        function showGameScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
        }

        function showTrumpDialog() {
            document.getElementById('trumpDialog').classList.remove('hidden');
        }

        function hideTrumpDialog() {
            document.getElementById('trumpDialog').classList.add('hidden');
        }

        function updateGameState(state) {
            
            if (!state) {
                console.error('Invalid game state');
                return;
            }

            // Update game info
            document.getElementById('gameCodeDisplay').textContent = state.code || '';
            document.getElementById('currentRound').textContent = state.currentRound || '';
            document.getElementById('trumpSuit').textContent = state.trumpSuit || 'Not chosen';
            document.getElementById('trumpSuit').className = getCardColor(state.trumpSuit || '♠');

            // Update players
            const playersGrid = document.getElementById('playersGrid');
            playersGrid.innerHTML = '';
            if (state.players && Array.isArray(state.players)) {
                state.players.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = `p-2 rounded ${
                        state.currentPlayer === player.name ? 'bg-blue-100' : 'bg-gray-100'
                    }`;
                    playerDiv.innerHTML = `
                        <p class="font-semibold">${player.name}</p>
                        <p>Tricks: ${player.trickCount}</p>
                        ${player.hasDogLife ? '<p class="text-red-500">Dog\'s Life!</p>' : ''}
                    `;
                    playersGrid.appendChild(playerDiv);
                });
            }

            // Update current trick
            const trickContainer = document.getElementById('currentTrickContainer');
            const trickDiv = document.getElementById('currentTrick');
            if (state.currentTrick && state.currentTrick.length > 0) {
                trickContainer.classList.remove('hidden');
                trickDiv.innerHTML = '';
                state.currentTrick.forEach(([player, card]) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'text-center';
                    
                    // Add animation class if this is the last played card
                    const isLastPlayed = state.lastPlayedCard === card && state.lastPlayer === player;
                    const cardElement = document.createElement('div');
                    cardElement.className = `card-size flex items-center justify-center ${getCardColor(card)} border rounded
                        ${isLastPlayed ? 'card-played' : ''}`;
                    cardElement.textContent = card;
                    
                    cardDiv.appendChild(cardElement);
                    cardDiv.innerHTML += `<div class="mt-2">${player}</div>`;
                    trickDiv.appendChild(cardDiv);
                });
            } else {
                trickContainer.classList.add('hidden');
            }

            // Update player's hand
            const handContainer = document.getElementById('playerHand');
            const handDiv = document.getElementById('handCards');
            if (hand && hand.length > 0) {
                handContainer.classList.remove('hidden');
                handDiv.innerHTML = '';
                hand.forEach(card => {
                    const playable = isCardPlayable(card);
                    const cardButton = document.createElement('button');
                    cardButton.className = `card-size flex items-center justify-center ${getCardColor(card)} border rounded
                        ${!playable ? 'opacity-50 cursor-not-allowed' : 'hover:scale-110 transition-transform cursor-pointer'}`;
                    cardButton.textContent = card;
                    
                    if (playable && state.currentPlayer === playerName) {
                        cardButton.onclick = () => playCard(card);
                        cardButton.style.cursor = 'pointer';
                    } else {
                        cardButton.disabled = true;
                    }
                    
                    handDiv.appendChild(cardButton);
                });
            } else {
                handContainer.classList.add('hidden');
            }

            // Show/hide start game button
            const startButton = document.getElementById('startGameButton');
            const addAIButton = document.getElementById('addAIButton');
            if (state.state === 'waiting') {
                startButton.classList.remove('hidden');
                addAIButton.classList.remove('hidden');
            } else {
                startButton.classList.add('hidden');
                addAIButton.classList.add('hidden');
            }
        }

        window.onload = () => {
            if (sessionId) {
                connectWebSocket({
                    type: 'reconnect',
                    sessionId: sessionId
                });
                showGameScreen();
            }
        };

        window.onbeforeunload = () => {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>
